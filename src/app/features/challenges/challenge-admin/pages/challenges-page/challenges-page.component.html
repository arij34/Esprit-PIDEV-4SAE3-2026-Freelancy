<div class="min-h-screen overflow-x-hidden bg-gray-50">
  <app-backoffice-header (menuClick)="onToggleSidebar()"></app-backoffice-header>

  <!-- Main Content -->
  <main>
    <div class="challenges-main-content">
    <!-- Loading state -->
    <div *ngIf="isLoading" class="mt-6 py-16 text-center">
      <div class="inline-block w-8 h-8 border-2 border-[#4F46E5] border-t-transparent rounded-full animate-spin mb-4"></div>
      <p class="text-gray-500">Loading challenges...</p>
    </div>
    <!-- Error state -->
    <div *ngIf="!isLoading && loadError" class="mt-6 py-16 text-center bg-amber-50 border border-amber-200 rounded-xl px-6">
      <svg class="w-12 h-12 text-amber-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
      </svg>
      <p class="text-amber-800 font-medium mb-1">Connection error</p>
      <p class="text-sm text-amber-700 mb-4">{{ loadError }}</p>
      <p class="text-xs text-amber-600 mb-4">Data is stored in your database. If you use an in-memory DB (H2), data is lost on backend restart. Use MySQL for persistence.</p>
      <button (click)="onRetryLoad()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors">Retry</button>
    </div>
    <!-- Challenges grid -->
    <div *ngIf="!isLoading && !loadError" class="mt-6">
      <app-modern-challenges-grid
        [challenges]="filteredChallenges"
        (edit)="onEditChallenge($event)"
        (duplicate)="onDuplicateChallenge($event)"
        (view)="onViewChallenge($event)"
        (viewParticipants)="onViewParticipants($event)"
        (delete)="onDeleteChallenge($event)"
        (goBack)="onBack()">
      </app-modern-challenges-grid>
    </div>
  </div>

  <!-- Edit Challenge Modal -->
  <app-edit-challenge-modal
    [isOpen]="isEditModalOpen"
    [challenge]="selectedChallenge"
    (close)="onCloseEditModal()"
    (save)="onSaveChallenge($event)">
  </app-edit-challenge-modal>

  <!-- Success Toast -->
  <div
    *ngIf="showSaveSuccess"
    class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] px-5 py-3 rounded-lg shadow-lg bg-green-600 text-white flex items-center gap-2 animate-fade-in">
    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
    </svg>
    <span class="font-medium">Changes successfully saved!</span>
  </div>

  <!-- Delete Confirmation Modal -->
  <app-delete-confirmation-modal
    [isOpen]="isDeleteModalOpen"
    title="Delete Challenge"
    [itemName]="challengeToDelete?.title || ''"
    message="This action cannot be undone. All associated data will be permanently removed."
    (confirm)="onConfirmDelete()"
    (cancel)="onCancelDelete()">
  </app-delete-confirmation-modal>

  <!-- Participants Modal -->
  <app-participants-modal
    [isOpen]="isParticipantsModalOpen"
    [challenge]="selectedChallenge"
    [participants]="selectedChallengeParticipants"
    (close)="onCloseParticipantsModal()">
  </app-participants-modal>

  <!-- View Challenge Tasks Modal -->
  <app-view-challenge-tasks-modal
    [isOpen]="isViewTasksModalOpen"
    [challenge]="selectedChallengeForView"
    [tasks]="selectedChallengeForView?.tasks || []"
    [isLoading]="viewTasksLoading"
    (close)="onCloseViewTasksModal()"
    (editChallenge)="onEditFromViewTasks($event)"
    (taskUpdated)="onTaskUpdated($event)"
    (taskDeleted)="onTaskDeleted($event)">
  </app-view-challenge-tasks-modal>
  </main>
</div>
